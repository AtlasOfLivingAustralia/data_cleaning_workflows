---
title: "Investigating WORMS"
author: "Fonti Kar"
date: "2022-08-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Resources: 
https://www.marinespecies.org/aphia.php?p=webservice&type=r
https://mmisw.org/ont/ioos/marine_biogeography
```{r}
# install.packages("worrms") https://docs.ropensci.org/worrms/index.html

pacman::p_load(tidyverse, worrms, here)
```

Read in AFD list

```{r}
afd_taxonomy <- read_csv("output/afd_species_clean.csv")
afd_species <- unique(afd_taxonomy$VALID_NAME) 
```

## A small test

```{r}
set.seed(8)

x <- sample(afd_species, 50) 

test_alltypes_ls <- wm_records_names(x)
test_alltypes_df <- bind_rows(test_alltypes_ls)

test_df |> select(scientificname, starts_with("is")) 

x[which(x %in% marine_sp)] # Seems to work well! 

```

## Lets expand it

```{r}
# If I do full list, it runs out of memory, reducing list to 500, 200, 100 seems to work
# afd_species_ls <- wm_records_names(afd_species) |> bind_rows() 

afd_species_ls <- wm_records_names(afd_species[1:100]) |> bind_rows()
```

## Workflow to exclude marine species from AFD checklist

```{r}
afd_species_ls |> pull(scientificname) -> marine_afd

## Excluding the marine species in VALID_NAME
afd_taxonomy |> filter(! VALID_NAME %in% marine_afd) -> afd_taxonomy_nomarine
```

## Code for for loop to query their API - slow, 1hr 

```{r}
afd_species <- unique(afd_taxonomy$VALID_NAME) 

afd_species_chunks <- split(afd_species, ceiling(seq_along(afd_species)/120))

for (i in 1:length(afd_species_chunks)) {
  
message(cat("Working on", names(afd_species_chunks)[i], "/", length(afd_species_chunks)))
  
try(worrms::wm_records_names(afd_species_chunks[[i]]) -> tmp)
    
    tmp |> bind_rows() -> afd_marine
    
    if(nrow(afd_marine) > 0){
    filenm <- paste0("output/rds/afd_marine", "_", names(afd_species_chunks)[i], ".rds")
  
    saveRDS(afd_marine, filenm)
  }
  
}
```

### Read in all the .rds and bind

```{r}
dir <- "output/rds/"
files <- list.files("output/rds/") 
files |> length()
filenms <- paste0(dir, files)

#myfiles = lapply(filenms, readRDS)

myfiles <- purrr::map(filenms, 
                     readRDS) |> bind_rows()

#write.csv(myfiles, "output/worrms_marine_splist.csv")
myfiles <- read_csv("output/worrms_marine_splist.csv")
```

### Trying to save csv/.txt in seperate parts so its more manageable

Each file must have a unique ID so things can be joined together. I suspect AphiaID would do the trick

```{r}
myfiles

names(myfiles)
myfiles <- myfiles[-1] # Remove first column (row numbers)

# Clean the list
myfiles %>% filter(!duplicated(AphiaID)) -> myfiles_clean

# Split by cols like WoRMS bulk download
names(species)
names(taxa)

# Select the 'species' columns
myfiles_clean %>% dplyr::select(1, starts_with("is")) -> my_species
myfiles_clean %>% dplyr::select(-starts_with("is")) -> my_taxa

# Save these files and check size
write_tsv(my_species, file = here("output", "worms" ,"species_data.txt")) # 463 KB
write_tsv(my_taxa, file = here("output", "worms" ,"taxonomic_data.txt")) #14 MB

# Can I read these in an join?
test_species <- read_tsv(here("output", "worms" ,"species_data.txt"))
test_taxa <- read_tsv(here("output", "worms" ,"taxonomic_data.txt")) # Throw warnings

# create a GRIIS list
test_list <- test_taxa |>  
  inner_join(test_species, by = "AphiaID") 
```

### Exclude marine species found by WoRMs by VALID_NAME with API query data

Options to exclude by scientificname or valid name

```{r}
test_list$scientificname |> length()
test_list$valid_name |> length()

(test_list$scientificname == test_list$valid_name) |> janitor::tabyl()

# Exclude the matches
afd_taxonomy |> filter(! VALID_NAME %in% test_list$scientificname) # 90,230
afd_taxonomy |> filter(! VALID_NAME %in% test_list$valid_name) # 92,730

## The excluded taxa
afd_taxonomy |> filter(VALID_NAME %in% test_list$scientificname) # 21,004 species excluded
afd_taxonomy |> filter(VALID_NAME %in% test_list$valid_name) # 18,493  species excluded
```


## Looking at bulk download

You can request a download of WoRMS here: https://www.marinespecies.org/usersrequest.php. 
Looks like they update once a month!

No valid name just scientific name

```{r}
species <- fread(here("ignore", "WoRMS_download_2022-10-01", "speciesprofile.txt"), quote = "")
taxa <- fread(here("ignore", "WoRMS_download_2022-10-01", "taxon.txt"), quote = "")

# create a GRIIS list
worms_list <- taxa |>  
  full_join(species, by = "taxonID") 

worms_list
names(worms_list)

## Number of strictly marine species
worms_list %>%
  filter(!specificEpithet == "",
         taxonomicStatus == "accepted",
         isMarine == 1,
         isTerrestrial == 0, isFreshwater == 0, isExtinct == 0) -> accepted_marine_worms  # 57414 specie


afd_species |> filter(VALID_NAME %in% accepted_marine_worms$scientificName) # 6,108 matched
```

