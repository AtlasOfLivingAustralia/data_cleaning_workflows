---
title: "Cross check"
author: "Fonti Kar"
date: "2022-10-31"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(tidyverse, arsenal, ozmaps, sf, CoordinateCleaner, dplyr, worrms)
```

## IA and ALA Melbourne workshop

### Read in data

```{r}
bigboi <- readRDS("data/ALA_invertebrate_data_clean_2020-10-28 copy.rds")
clean <- read_csv("data/NESPdata_ALA_wgs84.csv")

glimpse(bigboi)
glimpse(clean)
```

### Which taxa has been removed?

`exclud` contains rows of data that are not found in `clean`

```{r}
# ids that are in bigboi but not in clean
setdiff(bigboi$id, clean$id) -> exclud_id

bigboi %>% filter(id %in% exclud_id) %>% tibble() -> exclude

nrow(exclude) # 1577580
nrow(bigboi) - nrow(clean) # 1577632 

# Difference between  final exclusion and code exclusions
( nrow(bigboi) - nrow(clean) ) - nrow(exclude) # Further 52 rows were removed that can't be traced by id?
```

### Of those that match across datasets, has the values for name, coords and date changed?

```{r}
intersect(bigboi$id, clean$id) %>% match_id

bigboi %>% filter(id %in% match_id) %>% tibble() -> match

glimpse(match)

nrow(match) #  340111 
nrow(clean) # 340059

# Difference
nrow(match) - nrow(clean) # Difference of 52 
```

### Grab the variables of interest

```{r}
names(match)
names(clean)

match %>% dplyr::select(id, starts_with("lat"), starts_with("long"), contains("name"), year, -starts_with("common"), -c("georefPostDate", "verbatimEventDate", "dataResourceName", "incompleteCollectionDate", "names3", "names2"), -starts_with("invalid")) -> match_dat 

clean %>% dplyr::select(id, starts_with("lat"), starts_with("long"), contains("name"), contains("date"), year) -> clean_dat

# match_dat %>% as.data.table() -> match_dat
# clean_dat %>% as.data.table() -> clean_dat
```

### What are the 52 rows?

```{r}
# Which ones
left_join(clean_dat, match_dat, by = "id") -> comb

nrow(clean_dat)
nrow(match_dat)
nrow(comb) # Why is it longer?

setdiff(clean_dat$id, comb$id)
setdiff(comb$id, clean_dat$id)

comb$id[which(duplicated(comb$id))] -> dups

clean_dat %>% filter(id %in% dups)
bigboi %>% filter(id %in% dups) # There are duplicated rows in bigboi
```

### For each variable  that shares the same id, check the value

Rounding issues with Latitude and Longitude

```{r}
comb %>% 
  mutate(latitude.match = all.equal(latitude.x, latitude.y)) %>% 
  dplyr::select(id, latitude.x, latitude.y, latitude.match) %>% 
  pull(latitude.match) %>% table()

comb %>% 
  mutate(longitude.match = all.equal(longitude.x, longitude.y)) %>% 
  dplyr::select(id, longitude.x, longitude.y, longitude.match) %>% 
  pull(longitude.match) %>% table()

comb %>% 
  filter(! is.na(year.x) & ! is.na(year.y)) %>% 
  mutate(year.match = all.equal(year.x, year.y)) %>% 
  dplyr::select(id, year.x, year.y, year.match) %>% 
  pull(year.match) %>% table()

comb %>% 
  mutate(scientificName.match = all.equal(scientificName.x, scientificName.y)) %>% 
  dplyr::select(id, scientificName.x, scientificName.y, scientificName.match) %>% 
  pull(scientificName.match) %>% table()


all.equal(comb$scientificName.x, comb$scientificName.y)
comb[which(! comb$scientificName.x == comb$scientificName.y), ]
```

### Plot the coordinates for excluded data

```{r}
exclude %>% 
  dplyr::select(id, scientificName, latitude, longitude) -> exclude_dat

exclude_dat

# Get map of Australia
aus <- st_transform(ozmaps::ozmap_country, 4326)

ggplot() + 
  geom_sf(data = aus, 
          colour = "black", 
          fill = "white")  + 
    geom_point(data = exclude_dat, 
             mapping = aes(longitude, latitude), 
             colour = "black", size = 0.8, alpha = 0.05)

ggplot() + 
  geom_sf(data = aus, 
          colour = "black", 
          fill = "white")  # long 100 -170, lat 5 - 45

```

### Filter down to everything that is in and around Australia

```{r}
skimr::skim(exclude_dat)

exclude_dat %>% 
  filter(latitude <= -5 & latitude >= -45,
         longitude >=100 & longitude <= 170) -> exclude_dat_oz

# Re-plot
ggplot() + 
  geom_sf(data = aus, 
          colour = "black", 
          fill = "white")  + 
    geom_point(data = exclude_dat_oz, 
             mapping = aes(longitude, latitude), 
             colour = "black", size = 0.8, alpha = 0.05)
```

### Coordinate Cleaner

```{r}
exclude_dat_oz %>% data.frame() %>% clean_coordinates(lon = "longitude", lat = "latitude", 
                                                      species = "scientificName") -> cc_flags


summary(cc_flags)
plot(cc_flags, lon = "longitude", lat = "latitude")


# Exclude sea records
cc_flags$.sea

exclude_dat_oz_clean <- exclude_dat_oz[cc_flags$.sea,]

ggplot() + 
  geom_sf(data = aus, 
          colour = "black", 
          fill = "white")  + 
    geom_point(data = exclude_dat_oz_clean, 
             mapping = aes(longitude, latitude), 
             colour = "black", size = 0.8, alpha = 0.005)

exclude_dat_oz_clean
```

### Distinct species

```{r}
unique(exclude_dat_oz_clean$scientificName) -> distinct_sp
length(distinct_sp)

clean %>% filter(scientificName %in% distinct_sp) %>% pull(scientificName) %>% unique() %>%  length()
clean %>% filter(scientificName %in% distinct_sp) %>% pull(scientificName) %>% unique() -> clean_sp

# 1654 species that were completely removed
```

###  1654 species that were completely removed - what are these

```{r}
setdiff(distinct_sp, clean_sp) %>% length()

setdiff(distinct_sp, clean_sp) -> complete_removal_sp

bigboi %>% filter(scientificName %in% complete_removal_sp) -> complete_removal_dat

complete_removal_dat %>% 
  group_by(scientificName) %>% 
  summarise(n_records = n()) %>% 
  arrange(-n_records)
```

### Invasive species exclusion

```{r}
griis_species <- read_csv("data/GRIIS_Global_Register_of_Introduced_and_Invasive_Species_Australia.csv")

length(which(complete_removal_sp %in% griis_species$`Supplied Name`)) 

### With supplied name
complete_removal_sp[which(complete_removal_sp %in% griis_species$`Supplied Name`)] # 68 invasives species 
 
complete_removal_sp[which(! complete_removal_sp %in% griis_species$`Supplied Name`)] %>% length() #1586

complete_removal_sp[which(! complete_removal_sp %in% griis_species$`Supplied Name`)] -> complete_removal_noninvas_sup

### With scientificname
complete_removal_sp[which(complete_removal_sp %in% griis_species$scientificName)] # 77 invasives species 
 
complete_removal_sp[which(! complete_removal_sp %in% griis_species$scientificName)] %>% length() #1577

complete_removal_sp[which(! complete_removal_sp %in% griis_species$scientificName)] -> complete_removal_noninvas_sciN
```

### Marine species exclusion

Below we focus on scientificname

```{r}
worms <- read_csv("output/worrms_marine_splist.csv")

#Are any non invasive species that were excluded...marine?

colnames(worms)

worms %>% filter(scientificname %in% complete_removal_noninvas_sciN) %>% nrow() # Yes 1075

# Who are these? 
worms %>% filter(scientificname %in% complete_removal_noninvas_sciN) %>% pull(scientificname) %>% unique() -> marine_excl_sp
```

### Who are the remaining taxa?

```{r}
setdiff(complete_removal_noninvas_sciN, marine_excl_sp) -> remainder

bigboi %>%
  filter(scientificName %in% remainder) %>% 
  group_by(scientificName) %>% 
  summarise(n_records = n()) %>% 
  arrange(-n_records) 
```

### Cross check habitat with worrms again

```{r}
remainder_worms <- wm_records_names(remainder[1:100]) |> bind_rows()


remainder_worms$scientificname %>% unique()

remainder_worms_2 <- wm_records_names(remainder[101:201]) |> bind_rows()
remainder_worms_3 <- wm_records_names(remainder[202:302]) |> bind_rows()
remainder_worms_4 <- wm_records_names(remainder[303:404]) |> bind_rows()
remainder_worms_5 <- wm_records_names(remainder[405:506]) |> bind_rows()
remainder_worms_6 <- wm_records_names(remainder[507:606]) |> bind_rows()

# remainder_worms_7 <- wm_records_names(remainder[607:631]) |> bind_rows() 

bind_rows(remainder_worms,
          remainder_worms_2,
          remainder_worms_3,
          remainder_worms_4,
          remainder_worms_5,
          remainder_worms_6) -> remainder_worm_matches

remainder_worm_matches %>% filter(! is.na(scientificname)) %>% nrow() # 49 additional species removed
remainder_worm_matches %>% 
  filter(! is.na(scientificname)) %>% 
  pull(scientificname) -> second_pass_marine

setdiff(remainder, second_pass_marine) -> remainder_secondpass

```


```{r}
bigboi %>%
  filter(scientificName %in% remainder_secondpass) %>% 
  group_by(scientificName) %>% 
  summarise(n_records = n()) %>% 
  arrange(-n_records) -> left


write_csv(left, "output/unknown_removal.csv")
```

