---
title: "Cleaning AFD checklist"
date: "2022-08-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r }
pacman::p_load(dplyr, janitor, galah)

## Set working environment ####
data_path <- "data"
output_dir  <-  "output"

## Functions ####
source("scripts/remove_improper_names.R")
'%!in%' <- function(x,y)!('%in%'(x,y))
```

### Australian Faunal Directory taxonomy
Species lists for selected phyla created by AFD; australianfaunaldirectory@awe.gov.au

How does one download these species list? I wasn't able to get very far with: https://lists.ala.org.au/public/speciesLists
`afd_species$VALID_NAME` looks like a scientificName with some excetions sub species or another genus

```{r}
## Merge files
# afd_path <- paste0(data_path, "/AFD/AFD_invertebrate_ranks")
# afd_files <- list.files(afd_path, full.names = TRUE)
# afd_species <- do.call("rbind",lapply(afd_files, FUN = function(files){ read.csv(files)}))
# readr::write_csv(afd_species, "./output/afd_specieslist_full.csv")

afd_species <- read.csv(file.path(output_dir, "afd_splist_full.csv"))
all_species <- afd_species$VALID_NAME 
```

### Remove improper names 

Here the `remove_improper_names.R` function:
1. Removes any trailing white spaces or double spaces
2. Removes species where the name contains taxonomic modifiers e.g. ?, ex.,cf.
3. Optionally, removes single word names (e.g higher taxa without species suffix)

```{r}
species_record <- remove_improper_names(as.character(all_species),
                               allow.higher.taxa = FALSE,
                               allow.subspecies = TRUE)
sum(is.na(species_record$updated_list))
str(species_record)

## Update AFD taxonomy based on selected species
species <- as.character(na.omit(species_record$updated_list))
afd_species <- afd_species[which(afd_species$VALID_NAME %in% species),] 
  ## Note:  mismatch between length(species) and dim(afd_species), 
  ##        possibly due to duplicates being removed.
```

### Remove invasive species 
Source: https://lists.ala.org.au/speciesListItem/list/dr9884#list

This section of the workflow removes invasive species from the species list

```{r ##}
griis_species <- read.csv(file.path(data_path, "GRIIS_Global_Register_of_Introduced_and_Invasive_Species_Australia.csv"))

message(cat("number of AFD species listed in GRIIS: "),
        length(which(afd_species$VALID_NAME %in% griis_species$Supplied.Name)))

message("AFD species in GRIIS - Global Register of Introduced and Invasive Species - Australia: ")
afd_species$VALID_NAME[which(afd_species$VALID_NAME %in% griis_species$Supplied.Name)]

message("Removing AFD species in GRIIS ...")
afd_species <- afd_species[which(! afd_species$VALID_NAME %in% griis_species$Supplied.Name),]
```

## Counts for special characters in species names

This section tallies names that contain special characters, but doesn't do anything with me

```{r}
length(afd_species$VALID_NAME[grep("\"", afd_species$VALID_NAME, fixed = TRUE)])
length(afd_species$VALID_NAME[grep("\'", afd_species$VALID_NAME, fixed = TRUE)])
length(afd_species$VALID_NAME[grep("(", afd_species$VALID_NAME, fixed = TRUE)])
length(afd_species$VALID_NAME[grep("[", afd_species$VALID_NAME, fixed = TRUE)])
```

## Identify duplicates 

This section identify duplicates at the level of: 
- row
- VALID_NAME
- COMPLETE_NAME *There is a comment for using COMPLETE_NAME for searching dups

The number of species > the number of _unique_ species implies that there are duplicates.

```{r}
## List duplicates comparing all columns
##  Note: # gives zero = no duplicated rows
afd_species[duplicated(afd_species),] 

## Look for duplicates in specific columns
sum(is.na(afd_species$VALID_NAME))
length(afd_species$VALID_NAME)
length(unique(afd_species$VALID_NAME))
length(unique(afd_species$COMPLETE_NAME))
  ## JM - use COMPLETE_NAME for finding duplicates

## Duplicates in COMPLETE_NAME (excluding first appearance)
message(cat("Number of duplicated COMPLETE_NAME (excluding first appearance): "), 
            length(afd_species$COMPLETE_NAME[duplicated(afd_species$COMPLETE_NAME)]))
message("duplicated COMPLETE_NAME: ")
afd_species$COMPLETE_NAME[duplicated(afd_species$COMPLETE_NAME)]
```

## Duplicates in COMPLETE_NAME (including first appearance)

I don't exactly know what the second part of filtering statement is doing as it flagged different species

> duplicated(afd_species$COMPLETE_NAME[length(afd_species$COMPLETE_NAME):1])

What I don't understand are the indices as it is just a sequence [111305:1] which should match the entirety of `afd_species$COMPLETE_NAME` but the output names are different between the 

```{r}
temp <- afd_species[which(
  duplicated(afd_species$COMPLETE_NAME) | 
    duplicated(afd_species$COMPLETE_NAME[
      length(afd_species$COMPLETE_NAME):1])
  [length(afd_species$COMPLETE_NAME):1]),]
```

```{r}
d1 <- which(duplicated(afd_species$COMPLETE_NAME))

d2 <- which(duplicated(afd_species$COMPLETE_NAME[length(afd_species$COMPLETE_NAME):1]))  
which(duplicated(afd_species$COMPLETE_NAME[111305:1])) 

afd_species[d1,"COMPLETE_NAME"]
afd_species[d2,"COMPLETE_NAME"]
```

```{r}
message(cat("#duplicates in COMPLETE_NAME (including first appearance) : ", dim(temp)))
message("duplicated COMPLETE_NAME: ")
temp$COMPLETE_NAME

# readr::write_csv(temp, "./output/afd_completename_repeats.csv")
```

## Resolve duplicates from ALA list *in consultation with JM*

```{r}
## using TAXON_GUID from afd_completename_repeats_JRM.csv
# afd_species <- unique(afd_species$COMPLETE_NAME)
removed_dups <- c("b05771ae-bda7-497a-87c4-b55a0ebc4ca1",
                  "03acc9d4-a209-4bf0-9972-bc7d35d56aea",
                  "83d18631-e160-42ad-8332-89e4b8ba82b6",
                  "c05506f8-0188-4850-8136-7b45ea35638e",
                  "0bb19498-874f-4c6c-a637-124ec9878130")

afd_species <- afd_species[which(afd_species$TAXON_GUID %!in% removed_dups),]
#readr::write_csv(afd_species, "./outputs/afd_species_clean.csv")
```

Looks like this is a manual exclusion of some duplicates but not all of them? 5/17

These are the ones excluded

```{r}
afd_species |> filter(TAXON_GUID %in% removed_dups)
```


```{r}
## Checks
sp_words <- sapply(strsplit(as.character(afd_species$VALID_NAME), " "), length)
length(afd_species$VALID_NAME[which(sp_words == 5)])
length(afd_species$VALID_NAME[which(sp_words == 4)])
length(afd_species$VALID_NAME[which(sp_words == 3)])
length(afd_species$VALID_NAME[which(sp_words == 2)])
length(afd_species$VALID_NAME[which(sp_words == 1)])


## Checks
length(afd_species$VALID_NAME[grep("\"", afd_species$VALID_NAME, fixed = TRUE)])
length(afd_species$VALID_NAME[grep("\'", afd_species$VALID_NAME, fixed = TRUE)])
```

## galah code to obtain a species list of invertebrates from ALA

https://atlasoflivingaustralia.github.io/galah/articles/download_data.html#species-lists

```{r}
invert_species <- galah_call() |>
  galah_filter(
    taxonConceptID == galah_identify("Animalia")$identifier, 
    taxonConceptID != galah_identify("Chordata")$identifier) |>  # Filters NOT Chordata
  atlas_species()
```

# Want to see overlap/similar with InvertAus cleaned list

```{r}
# Quite a difference in number!
afd_species$VALID_NAME |> length() - invert_species |> nrow()  # 30583

# Species that exist in the AFD and not in the ALA query
setdiff(afd_species$VALID_NAME, invert_species$species) 

# Species that exist on ALA and not in AFD list, are these synonyms?
setdiff(invert_species$species, afd_species$VALID_NAME) 
```

