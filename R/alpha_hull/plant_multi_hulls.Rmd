---
title: "plant_multi_alphahull"
author: "Fonti Kar"
date: "2023-01-19"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = TRUE,
                      include = TRUE,
                      fig.align='center')

pacman::p_load(remotes, galah, tidyverse, here, skimr, janitor, sf)

# Configure galah
galah_config(email = "fonti.kar@gmail.com", 
             atlas = "Australia",
             download_reason_id = 10 # testing reason
             )
```

# Read in data

```{r}
vasc <- read_csv(here("data", "plants", "vascularplant.data.csv"))

skim(vasc)
```
# Initial clean

```{r}
### Creating an improved duplicate flag
vasc <- vasc %>% 
  group_by(species) %>% 
  mutate(duplicate = +duplicated(duplicate_specimen_flag == "potential_duplicate_specimen", "NA")) %>%
  ungroup()

clean_vasc <- vasc %>% 
  filter(!duplicate == TRUE) %>%  # Exclude duplicate records
  filter(! duplicated(longitude_used) & ! duplicated(latitude_used)) %>%  # Exclude duplicated coords
  drop_na(longitude_used, latitude_used) # Exclude records with missing coords
```

### Missing taxonomic information

```{r}
clean_vasc %>% 
  select(species, order, class) %>% 
  filter(is.na(order)) %>% 
  select(species) %>% 
  search_taxa() # Can't recover any put these in "Missing Order" 

clean_vasc <- clean_vasc %>% 
  mutate(order = ifelse(is.na(order), "Missing Order", order))
```


### Inconsistent higher taxonomic information

```{r}
clean_vasc %>% 
  select(species, order, class) %>% 
  distinct() %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order))
            ) %>% 
  filter(n_order > 1) 

clean_vasc %>% 
  filter(species == "Thelychiton speciosus") %>% 
  select(species, order, class)

# Add  Asparagales in NA for Thelychiton speciosus
clean_vasc <- clean_vasc %>% 
  mutate(order = ifelse(species == "Thelychiton speciosus", "Asparagales", order))
```

### Flag in cleaned dataset which ones are the Other species

```{r}
clean_vasc %>% 
  group_by(order) %>% 
  summarise(n_orders = sum(length(species))) %>% 
  arrange(-n_orders) %>% print(n = 50)

clean_vasc %>% 
  group_by(order) %>% 
  summarise(n_orders = sum(length(species))) %>% 
  arrange(-n_orders) %>% 
  filter(n_orders < 10) %>% 
  pull(order) -> other_orders

# Assign Other Orders
clean_vasc <- clean_vasc %>% 
  mutate(order_v2 = ifelse(order %in% other_orders, "Other Orders", order)) 
```
### Exclude taxa that have fewer than 4 obs after dropping NA

```{r}
data_insuffient_taxa <- clean_vasc %>% 
  group_by(species) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs < 4) %>% 
  pull(species)

clean_vasc <- clean_vasc %>% 
  filter(! species %in% data_insuffient_taxa)
```

### Taxa that have more than 2 class
```{r}
problem_taxa <- nested_vasc %>% pull(species) %>% janitor::tabyl() %>% filter(n > 1)

nested_vasc %>% filter(species %in% problem_taxa$.) %>% 
  arrange(species)

# ala_vasc %>% filter(species %in% problem_taxa$.) %>%
#   arrange(species)
```

### Use galah to name match all scientific names

```{r}
ala_taxonomy <- search_taxa(unique(clean_vasc$species)) %>% 
  select(order, class, search_term) %>% 
  rename(ala_order = order,
         ala_class = class)
  
# Left join these back
ala_vasc <-  nested_vasc %>% 
  left_join(ala_taxonomy, by = c("species" =  "search_term")) %>% 
  select(order_v2, ala_order, class, ala_class, species, occ)

# Put those smaller orders into a group
ala_vasc <- ala_vasc %>% 
  mutate(ala_order_v2 = ala_order,
         ala_order_v2 = ifelse(ala_order %in% other_orders, "Other Orders", ala_order)) 


# https://community.rstudio.com/t/how-to-keep-running-map-after-an-error/113097/5

# Nest the data
ala_vasc_nest <- ala_vasc %>% 
  drop_na(order, order_v2, class) %>% 
  group_by(order_v2, class, scientific_name) %>%
  arrange(order_v2, class, scientific_name) %>% 
  select(order, order_v2, class, scientific_name, longitude_used, latitude_used) %>% 
  nest(coords = c(longitude_used, latitude_used))
```


## Compile data into tibble 

```{r}
nested_vasc <- clean_vasc %>% 
  select(order_v2, species, longitude_used, latitude_used) %>% 
  drop_na(order_v2) %>% 
  group_by(order_v2, species) %>%
  arrange(order_v2, species) %>% 
  nest(occ = ends_with("used")) %>% 
  ungroup()
```

# Compute convex hulls

```{r}
join_chull <-function(chull_vec){
  polygn <- c(chull_vec, chull_vec[1])
  polygn
}

chull_overlap <- function(occ, chull_polygn){
  occ[chull_polygn,]
}

sf_transform <- function(occ){
  st_as_sf() %>% 
  st_set_crs(value = 4326)
}


polygon_sf <- function(polygon){
polygon %>%
  st_as_sf(coords=c("longitude_used","latitude_used"), crs = 4326) %>%
  summarise(geometry = st_combine(geometry)) %>%
  st_cast("POLYGON") -> x
  
  x
}

spatial_vasc <- nested_vasc %>% 
  mutate(chull = map(occ, 
                     chull),
         chull_join = map(chull, 
                             join_chull),
         chull_occ = map2(.x = occ,
                          .y = chull_join,
                          chull_overlap),
         chull_sf = map(chull_occ,
                        polygon_sf))
 

vasc_sf <- spatial_vasc$chull_sf %>%
  bind_rows() %>% 
  mutate(species = spatial_vasc$species, 
         order_v2 = spatial_vasc$order_v2)
```

## Plot covnex hulls

```{r}
aus <- st_transform(ozmaps::ozmap_country, 4326)

ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white")  +
  geom_sf(data = vasc_sf %>% filter(order_v2 == "Fabales"), aes(group = order_v2, fill = order_v2), alpha = 0.1) +
  facet_wrap(~order_v2) +
  theme(legend.position = "none") +
  coord_sf(xlim=c(135, 155), 
           ylim=c(-25,-45)) 





```


## Compute ahull data 

```{r}
# Compute ahull
get_ahull_sf <- function(df, alpha = 2){
  ahull <- df %>% 
    alphahull::ahull(alpha = alpha)  |> 
    hull2spatial::ahull2poly() |> 
  st_as_sf() |> 
  st_set_crs(value = 4326)
  
  return(ahull)
}


ala_vasc_test <- ala_vasc_nest %>%  
  mutate(occ_sf = map(coords,
                 ~ st_as_sf(.x, coords = c("longitude_used", "latitude_used"),
                            crs = 4326)),
         ahull_sf = map(coords, 
                        ~ purrr::possibly(
                          get_ahull_sf(.x), otherwise = NA
                          ))
      
         
  )


get_hull <- function(tibble){
  tibble %>% 
     mutate(ahull_sf = map(coords, 
                        ~ purrr::possibly(
                          get_ahull_sf(.x), otherwise = NA
                          )))
}


get_data_from_doi <- function(tibble_dois){
  test <- tibble_dois %>%
    mutate(doi_data = purrr::pmap(.l = list(
      dois = doi,
      email = "", ## your email here
      .flatten = TRUE),
      .f = purrr::possibly(roadoi::oadoi_fetch, ## the saving function! 
                           otherwise = NA))) #nreturn NA if no data is found
  
    return(test)
}


nested_doi[10,] %>%
  mutate(doi_data1 = 
    purrr::map(.x = data,
               .f = purrr::possibly(get_data_from_doi, otherwise = NA)
               )
    )
ala_vasc_test$ahull_sf

get_ahull_sf(ala_vasc_nest$coords[[21]] , longitude_used, latitude_used)
plot(ahull(ala_vasc_nest$coords[[21]], alpha = 2))
plot(ahull(ala_vasc_nest$coords[[32]], alpha = 2))
plot(ahull(ala_vasc_nest$coords[[44]], alpha = 2))
plot(ahull(ala_vasc_nest$coords[[80]], alpha = 2))

ala_vasc_nest$coords[[46]] %>% ahull(.,alpha = 2)
```

### Try a for loop with try

```{r}
ahull_sf <- list()

for(i in length(ala_vasc_nest$scientific_name) ){
ahull_sf[[i]] <- 
    try(get_ahull_sf(ala_vasc_nest$coords[i][[1]], longitude_used, latitude_used))
} 

ala_vasc_nest$coords[584][[1]] %>% get_ahull_sf()
```



```{r}
set.seed(9)

target_sp <- sample(vasc$scientific_name %>% unique(),1)

target_df <- vasc %>% 
  filter(scientific_name == target_sp)
```



### Clean the data first and make into `sf`

```{r}
target_df |> 
  select(longitude_used, latitude_used) |> 
  filter(!duplicated(longitude_used) & !duplicated(latitude_used)) |> 
  filter(!is.na(longitude_used) & !is.na(latitude_used)) -> target_clean

target_clean %>% 
  st_as_sf(coords = c("longitude_used", "latitude_used"), 
         crs = 4326) -> target_clean_sf
```

### Function to create alpha hull into `sf` object

```{r}
target_clean

get_ahull_sf <- function(df, long, lat, alpha = 2){
  ahull <- df %>% 
    dplyr::select({{ long }}, {{ lat }}) |> 
    alphahull::ahull(alpha = alpha)  |> 
    hull2spatial::ahull2poly() |> 
  st_as_sf() |> 
  st_set_crs(value = 4326)
  
  return(ahull)
}
```

### Plot it
 
```{r}
aus <- st_transform(ozmaps::ozmap_country, 4326)

ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white")  +
  geom_sf(data = target_clean_sf, colour = "black", size = 0.5) +  
  geom_sf(data = get_ahull_sf(target_clean, longitude_used, latitude_used), fill = "orange", alpha = 0.5) +
   coord_sf(xlim=c(130, 160), 
           ylim=c(-15,-45)) +
  labs(x = "Longtitude (DD)", y = "Latitude (DD)") + 
  theme_bw()
```

### Try to compute multiple species ahull 

```{r}
set.seed(9)

# Select a random set of 5 species with more than 3 occ points after cleaning
vasc %>% 
  dplyr::filter(!duplicated(longitude_used) & !duplicated(latitude_used)) |> 
  dplyr::filter(!is.na(longitude_used) & !is.na(latitude_used)) %>% 
  group_by(scientific_name) %>% 
  summarise(n_occ = n()) %>% 
  filter(n_occ > 4) %>% 
  pull( scientific_name ) %>% sample(5) -> target_sps


# Clean the data
clean_spatial_data <- function(data, long, lat){
  data|>
  dplyr::select(scientific_name, {{long}}, {{lat}}) |> 
    dplyr::filter(!duplicated({{long}}) & !duplicated({{lat}})) |> 
    dplyr::filter(!is.na( {{long}} ) & !is.na( {{lat}} ))
}

# Compute ahull
get_ahull_sf <- function(df, long, lat, alpha = 2){
  ahull <- df %>% 
    dplyr::select({{ long }}, {{ lat }}) |> 
    alphahull::ahull(alpha = alpha)  |> 
    hull2spatial::ahull2poly() |> 
  st_as_sf() |> 
  st_set_crs(value = 4326)
  
  return(ahull)
}

plant_occ <- tibble(scientific_name = target_sps,
                    raw_data = map(scientific_name,
                                   ~ filter(vasc, scientific_name == .x)),
                    clean_occ = map(raw_data, 
                                     ~ clean_spatial_data(.x, longitude_used, latitude_used)),
                    occ_sf = map(clean_occ,
                                 ~ st_as_sf(.x, coords = c("longitude_used", "latitude_used"),
                                            crs = 4326)),
                    ahull_sf = map(clean_occ, 
                                   ~ get_ahull_sf(.x, longitude_used, latitude_used))
                    )
```

### Plot these species' ahulls

```{r}
plot_ahull <- function(occ_sf, ahull_sf){
  aus <- st_transform(ozmaps::ozmap_country, 4326)
  
  ggplot() + 
    geom_sf(data = aus, colour = "black", fill = "white")  +
    geom_sf(data = occ_sf, colour = "black", size = 0.5) +  
    geom_sf(data = ahull_sf, fill = "orange", alpha = 0.5) +
  coord_sf(xlim=c(135, 155), 
           ylim=c(-20,-45)) +
  labs(x = "Longtitude (DD)", y = "Latitude (DD)") + 
  theme_bw()
}

plot_ahull(plant_occ$occ_sf[[1]], plant_occ$ahull_sf[[1]])

plant_occ |> 
  mutate(ahull_ggplot = map2(.x = occ_sf,
                             .y = ahull_sf,
                             .f = ~ plot_ahull(.x , .y)) 
  ) 
```

### Relying on one massive `sf` object

```{r}
# Get family information
plants <- 
  bind_rows(plant_occ$ahull_sf) %>%
  mutate(scientific_name = plant_occ$scientific_name) %>% 
  left_join(., vasc %>% 
              filter(scientific_name %in% target_sps) %>% 
              select(scientific_name, family) %>% 
              distinct())


aus <- st_transform(ozmaps::ozmap_country, 4326)

ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white")  +
  geom_sf(data = plants, aes(group = scientific_name, fill = scientific_name), alpha = 0.5) +
  coord_sf(xlim=c(145, 155), 
           ylim=c(-20,-45)) +
  labs(x = "Longtitude (DD)", y = "Latitude (DD)") + 
  facet_wrap(~family) +
  theme_bw()
  
```

### Try across ALL species that have more than 3 points after cleaning :D 

### Seems like subspecies are an issue with this

```{r}
library(stringr)
vasc %>% 
  filter(duplicate_specimen_flag == "potential_duplicate_specimen") %>% 
  pull(scientific_name) %>% unique() -> bad_species

```

```{r}
# Clean the data
clean_spatial_data <- function(data, long, lat){
  data|>
  dplyr::select(scientific_name, {{long}}, {{lat}}) |> 
    dplyr::filter(!duplicated({{long}}) & !duplicated({{lat}})) |> 
    dplyr::filter(!is.na( {{long}} ) & !is.na( {{lat}} ))
}

# Compute ahull
get_ahull_sf <- function(df, long, lat, alpha = 2){
  ahull <- df %>% 
    dplyr::select({{ long }}, {{ lat }}) |> 
    alphahull::ahull(alpha = alpha)  |> 
    hull2spatial::ahull2poly() |> 
  st_as_sf() |> 
  st_set_crs(value = 4326)
}

# Get data in order
plant_dat <- tibble(scientific_name = vasc %>% 
                      filter(!scientific_name %in% bad_species) %>% 
                      filter(!duplicated(longitude_used) & !duplicated(latitude_used)) |> 
                      filter(!is.na(longitude_used) & !is.na(latitude_used)) %>%
                      group_by(scientific_name) %>% 
                      summarise(n_occ = n()) %>% 
                      filter(n_occ > 4) %>% 
                      pull(scientific_name),
                    raw_data = map(scientific_name,
                                   ~ filter(vasc, scientific_name == .x)),
                    clean_occ = map(raw_data, 
                                     ~ clean_spatial_data(.x, longitude_used, latitude_used)),
                    occ_sf = map(clean_occ,
                                 ~ st_as_sf(.x, coords = c("longitude_used", "latitude_used"),
                                            crs = 4326)))

# Compute alpha hulls
plant_dat <- plant_dat %>% 
  mutate(ahull_sf = map(clean_occ, 
                        ~ get_ahull_sf(.x, longitude_used, latitude_used)))

# Join family infomation
plant_dat <- plant_dat %>% left_join(vasc %>% select(scientific_name, family, genus) %>% distinct(), by = "scientific_name")

plant_dat$ahull_sf <- map(plant_dat$ahull_sf,
                          ~ rename(.x, 
                                   ahull = geometry))

# plant_dat$ahull_sf <-
plant_dat$ahull_sf  <- map2(.x =plant_dat$ahull_sf,
                            .y = plant_dat$scientific_name,
                            ~ mutate(.x, 
                                     scientific_name = .y))

# Get family information
plant_ahull <- bind_rows(plant_dat$ahull_sf) %>%
  left_join(., plant_dat %>% select(scientific_name, family), by = "scientific_name")

aus <- st_transform(ozmaps::ozmap_country, 4326)

ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white")  +
  geom_sf(data = plant_ahull, aes(group = scientific_name, fill = family), alpha = 0.5) +
  coord_sf(xlim=c(145, 155), 
           ylim=c(-20,-45)) +
  labs(x = "Longtitude (DD)", y = "Latitude (DD)") + 
  facet_wrap(~family) +
  theme_bw() 

```





