---
title: "Concaveman"
author: "Fonti Kar"
date: "2023-02-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

pacman::p_load(galah, sf, ozmaps, ggforce, ggmap, tidyverse, here, skimr)
```


### Configuring ALA account
```{r}
galah_config(email = Sys.getenv("ALA_email"), 
             atlas = "Australia",
             download_reason_id = 10 # testing reason
             )
```

### Read in data

```{r}
inverts <- read_csv(here("data", "inverts", "invertebrate.data.fixed.csv"))

str(inverts)
skim(inverts)
```

### Precleaning

```{r}
clean_inv <- inverts %>% 
  filter(! duplicated(longitude) & ! duplicated(latitude)) %>%  # Exclude duplicated coords
  drop_na(longitude, latitude) # Exclude records with missing coords
```

### Summaries of all taxonomic levels

Plot by class might be better! Each family is only represented by 1 taxa

```{r}
clean_inv %>% 
  group_by(class) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>% 
  arrange(-n_sp)  %>% 
  print(n = 50) 

clean_inv %>% 
  group_by(family) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>%
  arrange(-n_sp) 

## Other class
other_class <- clean_inv %>% 
  group_by(class) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>%
  filter(n_sp <= 10 | is.na(class)) %>% 
  pull(class)

## Case study
clean_inv %>% 
  filter(class == "Arachnida", 
         family == "Salticidae") %>% 
  group_by(scientific_name) %>% 
  summarise(n()) %>% 
  arrange(-`n()`) %>% slice(1:10) %>% 
  pull(scientific_name) -> top10jspiders #Top 5 species
``` 

### Create new class variable

```{r}
clean_inv <- clean_inv %>% 
  mutate(plot_class = ifelse(class %in% other_class, "Other", class)) 

clean_inv %>% 
  group_by(plot_class) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>% 
  arrange(-n_sp)  %>% 
  print(n = 50)  # Check if we can see "Other"
```

### Try plotting these funky hulls for top10 spiders as an example

#### Filter data and make sf object
```{r}
spiderdat <- clean_inv %>% 
  filter(scientific_name %in% top10jspiders)

spider_sf<- spiderdat %>% 
  st_as_sf(coords = c("longitude", "latitude"), crs = 4326)


```

#### Make base map components

```{r}
aus <- st_transform(ozmap_country, 4326)

ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white") +
  geom_sf(data = spider_sf %>% filter(!scientific_name %in% c("Apricia jovialis", 
                                                              "Apricia bracteata",
                                                              "Pellenes bitaeniata"))) +
  geom_mark_hull(spiderdat %>% filter(!scientific_name %in% c("Apricia jovialis", 
                                                              "Apricia bracteata",
                                                            "Pellenes bitaeniata")), mapping = aes(x = longitude, y = latitude,
                                fill = scientific_name, label = scientific_name), alpha = 0.2, con.cap = 0)  + 
  theme_minimal() +
  theme(legend.position = "none")
  
```

### Trying beautiful stamen maps

```{r}
map <- get_stamenmap( bbox = c(left = 100, bottom = -45, right = 160, top = -8), zoom = 5, maptype = "watercolor")

ggmap(map) + 
  geom_point(spiderdat %>% filter(scientific_name %in% c("Maratus mungaich", 
                                                             "Maratus vespertilio",
                                                             "Hypoblemum scutulatum",
                                                             "Afraflacilla stridulator")), mapping = aes(x = longitude, y = latitude)) + 
  geom_mark_hull(spiderdat %>% filter(scientific_name %in% c("Maratus mungaich", 
                                                             "Maratus vespertilio",
                                                             "Hypoblemum scutulatum",
                                                             "Afraflacilla stridulator")), 
                 mapping = aes(x = longitude, y = latitude, group = scientific_name, label = scientific_name),
                 alpha = 0.2, con.cap = 0, concavity = 2) +
  theme_void() + 
  theme(
    plot.title = element_text(colour = "orange"), 
    panel.border = element_rect(colour = "grey", fill=NA, size=2)
  )
```


### Read in fire layer

```{r}
fname <- here("ignore", "NIAFED_v20200623", "NIAFED_20190701_20200622_v20200623.shp")

fire <- st_read(fname)
fire_2 <- st_transform(fire, crs = 4326)

fire_2[1]

ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white") + 
  geom_sf(data = fire_2, color = "mediumorchid4") + 
  geom_sf(data = spider_sf %>% filter(!scientific_name %in% c("Apricia jovialis", 
                                                              "Apricia bracteata",
                                                              "Pellenes bitaeniata"))) +
  geom_mark_hull(spiderdat %>% filter(!scientific_name %in% c("Apricia jovialis", 
                                                              "Apricia bracteata",
                                                            "Pellenes bitaeniata")), mapping = aes(x = longitude, y = latitude,
                                group = scientific_name), alpha = 0.2, con.cap = 0)  + 
  theme_minimal() +
  theme(legend.position = "none")
```





