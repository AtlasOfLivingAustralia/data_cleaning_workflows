---
title: "Range overlap"
author: "Fonti Kar, Margot Scheider"
date: "2023-02-28"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The full force of the 2019/2020 Australian bush fires had a devastating impact on the natural landscape, threatening our native biodiversity. More than ever, decision makers need curated, open access biodiversity data to help respond effectively to future bush fires. Our team at the Atlas of Living Australia (ALA) have been working with experts in the field to collate biodiversity datasets that can be used for off-the-shelf bush fire assessments. The two datasets are of taxonomic groups that are often overlooked during bush fires, Australian [invertebrates](link to ALA page?) (insects, snails, spiders) and  Australian [vascular plants](link to ALA page?). We are thrilled to announce that both datasets are now publicly available from [CSIRO's data access portal](https://data.csiro.au/collection/csiro:56679).

Quick sumamry of datasets? how many species etc

In this ALA labs post, we will showcase both datasets and show you how to calculate area of range overlap with fire extent during the 2019/2020 bush fire season. 

This post expands our previous post on [spatial polgyons for conservation mapping](XXX), where we discussed the applications of convex and alpha hulls to visualise spatial distributions of data deficient species. Here, we will learn how to plot a new form of spatial polygon - a [*concave hull*](https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.676.6258&rep=rep1&type=pdf). Unlike its counterparts, concave hulls have the added flexibility to adjust its concavity which enables a more accurate estimation of species range.


## Get biodiversity data

Let's start by installing and loading the packages we need.

```{r, loadpkg, eval = FALSE}
# install.packages("pacman")
pacman::p_load(tidyverse, here, sf, ozmaps, concaveman, job, cowplot)
```

Next, we will go to the Data Access Portal to [download the invertebrate and vascular plant data](https://data.csiro.au/collection/csiro:56679) 

Click on the "Download" button on the top right corner and select "Download all files as Zip archive". Locate the zip file and move it to an appropriate folder and then double click on it to unzip the download. 

![]( `r here("R/","alalabs", "images", "DAP.png")` ) 

Once you have unzipped the download, we can read the curated datasets into R:
```{r loaddata, eval = FALSE}
inverts <- read_csv(here("data", "Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "invertebrate.data.csv"))
```
```{r loaddatalocal, eval = TRUE, echo = FALSE, include = FALSE}
inverts <- read_csv(here("ignore", "Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "invertebrate.data.csv"))
```

## Get fire layer

Now we will go to [this website](https://www.environment.gov.au/fed/catalog/search/resource/details.page?uuid=%7B9ACDCB09-0364-4FE8-9459-2A56C792C743%7D) to download the fire extent layer

(Walk through instructions of download and unzip)

Once the fire layer has been downloaded, we can read it into R and set the projection to EPSG:4326 and remove elevation values as we are interested in the extent of fire

```{r firelayer, eval = FALSE}
fire <- st_read(here("shapefile", "NIAFED_v20200623", "NIAFED_20190701_20200622_v20200623.shp")) %>% 
  st_transform(crs = 4326) %>% 
  st_zm()   #Remove Z or M values
```

```{r firelayerlocal, eval = TRUE, echo = FALSE, include = FALSE}
fire <- st_read(here("ignore", "NIAFED_v20200623", "NIAFED_20190701_20200622_v20200623.shp")) %>% 
  st_transform(crs = 4326) %>% 
  st_zm()   #Remove Z or M values

total_fire_area <- fire %>% st_area()
```

## Precleaning

First we will focus on the inverts data..

There is no need to remove duplicates or NA as there are none in curated dataset. 

We will only extract species that have more than 4 observations

First, we need to compute the number of observations for each species, then we will pull out the names for species that have more than 4 observation

```{r}
more_than_4_obs <- inverts %>% 
  group_by(scientific_name) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs > 4) %>% 
  pull(scientific_name)

more_than_4_obs
```

Once we have the names for the species we want we can extract data for species that have more than 4 observations and exclude the surrounding islands of Australia as they drastically alter the shape and form of concave hulls

```{r}
inverts_subset <- inverts %>%
  filter(scientific_name %in% more_than_4_obs) %>% 
   filter(latitude < -10, latitude >= -45,
         longitude >= 113, longitude <= 155) %>% 
  select(scientific_name:family, longitude, latitude)
```

## Nest occurrence data 

```{r}
inverts_nest <- inverts_subset %>% 
  nest(coords = c(longitude, latitude))

inverts_nest
```

###  Transform coordinates into a `sf` object and Compute concave hull

This part may takes around 10 minutes if you apply it to the whole dataset. We recommend submitting it as a RStudio background job using the `job` function  Note that the code we want to run going within the `{}`.  We also suggest  saving the output locally so you don't want to run this step every time! 

```{r}
job::job(
  {inverts_nest_concave <- inverts_nest %>%
    mutate(points_sf = map(.x = coords,
                           ~ st_as_sf(.x, coords = c("longitude", "latitude"),
                                      crs = 4326)
                           ), 
           concave_sf = map(points_sf,
                            ~ concaveman(.x)
           )
           )
  }
  )
  

saveRDS(inverts_nest_concave, here("output", "processed_data", "inverts_nest_concave"))

 inverts_nest_concave <- readRDS(here("output", "processed_data", "inverts_nest_concave"))
```

## A plot of all specie's ranges

```{r}
# Unnest the data
all_species_concave <- inverts_nest_concave %>% 
  select(scientific_name:family, points_sf, concave_sf) %>% 
  unnest(cols = c(points_sf, concave_sf)) %>% 
  st_as_sf(crs = 4326) %>% 
  rename(points = geometry)

aus <- st_transform(ozmap_country, 4326)

base_map <- ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white") +
  geom_sf(data = fire, fill = "#FEC3A6", colour = "#FEC3A6")


base_map + 
  geom_sf(data = all_species_concave, 
          aes(geometry = polygons, fill = scientific_name), alpha = 0.001) + 
  #geom_sf(data = all_species_concave, aes(geometry = points, colour = scientific_name), size = 1, alpha = 0.1) + 
  theme_minimal() + 
  theme(legend.position = "none")
  #facet_wrap(~class)
```

## Subset a family

```{r}
bees_nest <- inverts_nest_concave %>% 
  filter(family == "apidae") 
```

### Compute fire overlap and calculate the area of overlap

This step takes a long time if you want to apply it across all species in the dataset. So we will just do the computation for the Phasmids only in this walk through.

```{r, warning=FALSE}
sf_use_s2(FALSE)

bess_nest_rng_overlap <- bees_nest %>% 
  mutate(overlap_sf = map(concave_sf, 
                       ~ st_intersection(fire, .x)
                       ),
         overlap_area = map(overlap_sf,
                              ~ st_area(.x)),
         percent_overlap = map2(.x = overlap_area,
                                .y = concave_sf,
                               ~ (.x / st_area(.y))*100)
  ) %>% 
  unnest(cols = c(overlap_area, percent_overlap))

bess_nest_rng_overlap %>% pluck("overlap_sf",1)

```

## Rank species by their area overlap with fire and take the top 5

```{r}
bess_nest_rng_overlap %>% 
  arrange(percent_overlap) %>% 
  slice_max(order_by = percent_overlap,
              n = 3) -> top3

top3
```

### Unnest and rename relevant columns for plotting 

```{r, warnings = FALSE}
bee_plotready <- top3 %>% 
  select(scientific_name, overlap_area, percent_overlap, points_sf, concave_sf, overlap_sf) %>% 
  unnest() %>% 
  rename(points = geometry, 
         concave = polygons, 
         overlap = geometry1) %>% 
  select(-Id)
```

## Visualise fire extent and range overlap

### Create a base map

```{r}
aus <- st_transform(ozmap_country, 4326)

base_map_simplify <- ggplot() + 
  geom_sf(data = aus, colour = "black", fill = "white") +
  geom_sf(data = fire, fill = "#FEC3A6", colour = "#FEC3A6")
```

### Add overlap of seelected species

```{r}
main_map <- base_map_simplify + 
  geom_sf(data = bee_plotready, aes(geometry = overlap), colour = "#FF925C", fill = "#FF925C") + 
  geom_sf(data = bee_plotready, aes(geometry = concave, colour = scientific_name, fill = scientific_name), size = 1.5, alpha = 0.0045) + 
  geom_sf(data = bee_plotready, aes(geometry = points, colour = scientific_name), size = 1) + 
  scale_colour_manual(values = c("#023E50", "#7B8A6A", "#3C908E")) + 
  scale_fill_manual(values = c("#023E50", "#7B8A6A", "#3C908E")) + 
  guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
  coord_sf(xlim = c(128, 158)) +
  theme_minimal() + 
  theme(legend.title= element_blank(),
        legend.position = "bottom") 

main_map
```

### Add inset map

```{r}
inset <- main_map + 
   coord_sf(
    xlim = c(142.8 , 145.3),
    ylim = c(-15.9, -13.25),
    expand = FALSE
    ) + 
   theme_void() +
   theme(legend.position = "none",
         panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.6))

inset

# Draw a box around the inset area 
main_bbox <- main_map + 
   geom_rect(aes(xmin = 142.8, xmax = 145.3,
             ymin = -15.9, ymax = -13.25),
             colour = "black",
             linewidth = 0.2, 
             fill = NA) 
 
# Put it all together
ggdraw(main_bbox) +
  draw_plot(inset, x = 0.48, y = 0.62, 
            width =0.45, height = 0.3)

# Fix the legend and add overlap colour
```


## Plant map

```{r}
# Read in data
vplants <- read_csv(here("ignore","Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "vascularplant.data.csv"))
```


## Other stuff

CoordinateCleaner
```{r}
library(CoordinateCleaner)

sea_flags <- cc_sea(inverts_subset, 
                    lon = "longitude", 
                    lat = "latitude", 
                    value = "flagged")

sea_flags_buffered <- cc_sea(inverts_subset, 
                             ref = buffland,
                             lon = "longitude", 
                             lat = "latitude",
                             value = "flagged")

inverts_subset %>% 
  mutate(buffered_outlier = !sea_flags_buffered, 
         sea_outlier = !sea_flags) -> inverts_subset

#plot results
ggplot()+
  borders(fill = "grey60")+
  geom_point(data = inverts_subset,
             mapping = aes(x = longitude, y = latitude, col = buffered_outlier))+
  scale_color_viridis(discrete = T, name = "Flagged outlier")+
  coord_fixed(ylim = c(-45, -5),
              xlim = c(100, 160))+
  theme_bw()+
  theme(legend.position = "bottom")

```


Summary of higher taxa

```{r}
# All classes
inverts$class %>% janitor::tabyl()

# Aracnid obs
inverts %>% 
  filter(class == "arachnida") %>% 
  group_by(family) %>% 
  summarise(n_obs = n(), 
            n_sp = length(unique(scientific_name))) %>% 
  filter(n_obs > 4) %>% 
  print(n = 200)

# Phasmids obs
inverts %>% 
  filter(family == "phasmatidae") %>% 
  group_by(scientific_name) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs > 4)
  
```


plain old filtering

```{r}
inverts_subset %>% 
  -> inverts_close

ggplot()+
  borders(fill = "grey60")+
  geom_point(data = inverts_close,
             mapping = aes(x = longitude, y = latitude))+
  viridis::scale_color_viridis(discrete = T, name = "Flagged outlier")+
  coord_fixed(ylim = c(-45, -5),
              xlim = c(100, 160))+
  theme_bw()+
  theme(legend.position = "bottom")

```