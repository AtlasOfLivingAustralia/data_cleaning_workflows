---
title: "Range overlap"
author: "Fonti Kar, Margot Scheider"
date: "2023-02-28"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The full force of the 2019/2020 Australian bush fires had a devastating impact on the natural landscape, threatening our native biodiversity. More than ever, decision makers need curated, open access biodiversity data to help respond effectively to future bush fires. Our team at the Atlas of Living Australia (ALA) have been working with experts in the field to collate biodiversity datasets that can be used for off-the-shelf bush fire assessments. The two datasets are of taxonomic groups that are often overlooked during bush fires, Australian [invertebrates](link to ALA page?) (insects, snails, spiders) and  Australian [vascular plants](link to ALA page?). We are thrilled to announce that both datasets are now publicly available from [CSIRO's data access portal](https://data.csiro.au/collection/csiro:56679).

In this ALA labs post, we will showcase both datasets and show you how to calculate area of range overlap with fire extent during the 2019/2020 bush fire season. 

This post expands our previous post on [spatial polgyons for conservation mapping](XXX), where we discussed the applications of convex and alpha hulls to visualise spatial distributions of data deficient species. Here, we will learn how to plot a new form of spatial polygon - a [*concave hull*](https://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.676.6258&rep=rep1&type=pdf). Unlike its counterparts, concave hulls have the added flexibility to adjust its concavity which enables a more accurate estimation of species range.


## Get biodiversity data

Let's start by installing and loading the packages we need.

```{r, loadpkg}
# install.packages("pacman")
pacman::p_load(tidyverse, here, rmapshaper, sf, ggpointdensity, viridis, ozmaps, concaveman, job, cowplot, patchwork)
```

Next, we will go to the Data Access Portal to [download the invertebrate and vascular plant data](https://data.csiro.au/collection/csiro:56679) 

Click on the "Download" button on the top right corner and select "Download all files as Zip archive". Locate the zip file and move it to an appropriate folder and then double click on it to unzip the download. 

![]( `r here("R/","alalabs", "images", "DAP.png")` ) 

Once you have unzipped the download, we can read the curated datasets into R:
```{r loaddata, eval = FALSE}
# Invertebrates data
inverts <- read_csv(here("data", "Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "invertebrate.data.csv"))

# Vascular plants data
## Rename coordinate variables for consistency
vplants <- read_csv(here("data","Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "vascularplant.data.csv")) %>%
  rename(latitude = latitude_used,
         longitude = longitude_used)
```

```{r loaddatalocal, eval = TRUE, echo = FALSE, include = FALSE}
inverts <- read_csv(here("ignore", "Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "invertebrate.data.csv"))

vplants <- read_csv(here("ignore","Curated_Plant_and_Invertebrate_Data_for_Bushfire_Modelling", "vascularplant.data.csv")) %>%
  rename(latitude = latitude_used,
         longitude = longitude_used)
```

## Get fire layer

Now we will go to [this website](https://www.environment.gov.au/fed/catalog/search/resource/details.page?uuid=%7B9ACDCB09-0364-4FE8-9459-2A56C792C743%7D) to download the fire shapefile

(Walk through instructions of download and unzip)

Once the fire shapefile has been downloaded, we can read it into R and set the projection to EPSG:4326 and remove elevation values as we are only interested in the extent of fire.

```{r firelayer, eval = FALSE}
fire <- st_read(here("shapefile", "NIAFED_v20200623", "NIAFED_20190701_20200622_v20200623.shp")) %>% 
  st_transform(crs = 4326) %>% 
  st_zm()   #Remove Z or M values
```

```{r firelayerlocal, eval = TRUE, echo = FALSE, include = FALSE}
fire <- st_read(here("ignore", "NIAFED_v20200623", "NIAFED_20190701_20200622_v20200623.shp")) %>% 
  st_transform(crs = 4326) %>% 
  st_zm() %>%   #Remove Z or M values
  ms_simplify() # Simplify the fire layer for efficient plotting
```

## Precleaning

[Do tabs? for inverts and plants]

Note that there is no need to remove duplicates or NA as there are none in the curated datasets. Here we will focus on cleaning the invertebrates data, but the same steps apply to to vascular plants data.

Concave hulls can be best estimate with at least 4 observations. Here, we will extract species that fit this criteria by calculating the number of observations for each species, then we pulling out the names for species that have more than 4 observations. Once we have the names for the species we will extract their respective data.

```{r}
more_than_4_obs <- inverts %>% 
  group_by(scientific_name) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs > 4) %>% 
  pull(scientific_name)

more_than_4_obs %>% head()

inverts_subset <- inverts %>%
  filter(scientific_name %in% more_than_4_obs)
```
 
 We also want to want to narrow down our records to mainland of Australia and Tasmania as records from Australia's offshore islands can drastically alter the shape of a species' concave hull.

```{r}
subset_mainland <- inverts_subset %>% 
  filter(latitude < -10, latitude >= -45,
         longitude >= 113, longitude <= 155) %>% 
  select(scientific_name:family, longitude, latitude)
```

## Nest occurrence data 

We will then nest the coordinate data into a [list column](https://jennybc.github.io/purrr-tutorial/ls13_list-columns.html). List columns are a very useful data structure for iterative analysis. In this case, each specie's coordinate data is condensed  down into sub-tables. This is useful as we will make computing concave hulls and range overlap with fire extent at the species level.

```{r}
inverts_nest <- subset_mainland %>% 
  nest(coords = c(longitude, latitude))

inverts_nest
```

You can inspect the list column like this: 

```{r}
inverts_nest %>% pluck("coords", 1) # 1 refers to the first element of the list column
```

## A glimpse of spatial distributions in both datasets

[Note sure if we want to put plants up here so readers get and idea of both datasets at the beginning? alternatively, we move this right at the beginning then we talk about precleaning]

There are over [description of datasets summary of class/families/species/n_records per species], so its impossible to visualise all data points and concave hulls at once. Instead, we will plot all the data points and concave hulls of a random species from each class to give you a sense of the dataset.

```{r, collapse=TRUE}
# Set seed so we all get the same results
set.seed(123) 

# Subset a random species from each class 
subset <- inverts_nest %>% 
  group_by(class) %>% 
  slice_sample(n = 1) 

# Convert coordinates into sf object and compute concave hulls as list columns.
subset_concave <- subset %>%
    mutate(points_sf = map(.x = coords,
                           ~ st_as_sf(.x, coords = c("longitude", "latitude"),
                                      crs = 4326)
                           ), 
           concave_sf = map(points_sf,
                            ~ concaveman(.x)
           )
           )

# Unnest the concave hull list column
subset_concave <- subset_concave %>% 
  select(scientific_name:family, concave_sf) %>% 
  unnest(cols = c(concave_sf)) %>% 
  ungroup() %>% 
  st_sf(crs = 4326) 

# Retrieve Australia polygon
aus <- st_transform(ozmap_country, 4326)

# Create plot of concave hull
all_concave <- ggplot() + 
  geom_sf(data = aus, colour = "black", fill = NA) +
  geom_sf(data = subset_concave, fill = "#609966", alpha = 0.2, lwd = 0) +
  coord_sf(xlim = c(110, 155)) +
  theme_void() 

# Create plot showing overlapping points
inverts_points_map <- ggplot() +
  geom_pointdensity(data = inverts_subset,
                    mapping = aes(x = longitude,
                                  y = latitude)) +
  geom_sf(data = aus, colour = "white", fill = NA) +  
  scale_color_viridis(option = "E", begin = 0.1) +
  coord_sf(xlim = c(110, 155)) +
  guides(colour = guide_colourbar(
    title = "Number of \noverlapping points"),
    alpha = "none") +
  theme_void() +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.title.align = 0.5)
  
all_concave + inverts_points_map
```

Note that we are using `species` instead of `scientific_name` in the plants dataset

```{r, collapse=TRUE}
# Precleaning
## Identify species that have more than 4 observations 
more_than_4_obs_plants <- vplants %>% 
  group_by(scientific_name) %>% 
  summarise(n_obs = n()) %>% 
  filter(n_obs > 4) %>% 
  pull(scientific_name)

more_than_4_obs_plants

## Subset species with more than 4 observations,exclude Australia's neighbouring islands and 
vplant_mainland <- vplants %>%
  filter(scientific_name %in% more_than_4_obs_plants) %>% 
  filter(latitude < -10, latitude >= -45,
         longitude >= 113, longitude <= 155) %>% 
  select(species, class:genus, longitude, latitude) 

## Nest the dataset
vplant_nest <-  vplant_mainland %>% 
   nest(coords = c(longitude, latitude))

## Subset data randomly one hull per family
set.seed(123) 

plant_subset <- vplant_nest %>% 
  group_by(family) %>% 
  slice_sample(n = 1) 

# Compute concave hulls
pl_subset_concave <- plant_subset %>%
    mutate(points_sf = map(.x = coords,
                           ~ st_as_sf(.x, coords = c("longitude", "latitude"),
                                      crs = 4326)
                           ), 
           concave_sf = map(points_sf,
                            ~ concaveman(.x)
           )
           )

## Unnest the data
pl_subset_concave <- pl_subset_concave %>% 
  select(species:family, concave_sf) %>% 
  unnest(cols = c(concave_sf)) %>% 
  st_as_sf(crs = 4326) 

# Plotting spatial distributions
plant_concave <- ggplot() + 
  geom_sf(data = aus, colour = "black", fill = NA) +
  geom_sf(data = pl_subset_concave, fill = "#609966", colour = NA, alpha = 0.15, lwd = 0) + 
  coord_sf(xlim = c(140, 158),
           ylim = c(-23, -43)) +
  theme_void() 

# Create plot showing overlapping points
plants_points_map <- ggplot() +
  geom_pointdensity(data = vplant_mainland,
                    mapping = aes(x = longitude,
                                  y = latitude)) +
  geom_sf(data = aus, colour = "white", fill = NA) +  
  scale_color_viridis(option = "E", begin = 0.1) +
  coord_sf(xlim = c(140, 158),
           ylim = c(-23, -43)) +
  guides(colour = guide_colourbar(
    title = "Number of \noverlapping points"),
    alpha = "none") +
  theme_void() +
  theme(legend.margin = margin(0, 0, 0, 0),
        legend.box.margin = margin(0, 0, 0, 0),
        legend.title.align = 0.5)
  
plant_concave + plants_points_map
```

## Species range overlap with fire extent

Computation of range overlap with fire extent takes a lot of memory and processing time so we will do the next part of the walk through with the bee family (Apidae) as an example.

```{r}
bees <- inverts_nest %>% 
  filter(family == "apidae") 
```

### Compute concave hull

Here we will transform each specie's coordinates into a `sf` object and compute their concave hulls.

```{r}
bees_concave <- bees %>%
    mutate(points_sf = map(.x = coords,
                           ~ st_as_sf(.x, coords = c("longitude", "latitude"),
                                      crs = 4326)
                           ), 
           concave_sf = map(points_sf,
                            ~ concaveman(.x)
           )
           )
```

### Compute range overlap and descriptive statistics

We will assume that each species concave hull is representative of it's range in order to calculate range overlap with fire extent.

In order to do this, we need to set `sf_use_s2(FALSE)` which assumes the Earth is flat and not spherical. While this a limitation of the method, it still gives us a good approximation. 

Let's identify the overlap between each species' concave hull with fire extent using `st_intersection`. We can then use `st_area` to calculate the area (m^2) the overlap and convert it into percentage of each specie's original range. 

Notice that we are unnesting `overlap_area` and `percent_overlap` so they can be seen in the main tibble

```{r, warning=FALSE}
sf_use_s2(FALSE) 

bees_overlap <- bees_concave %>% 
  mutate(overlap_sf = map(concave_sf, 
                       possibly(~ st_intersection(fire, .x) %>% select(-Id))
                       ),
         overlap_area = map(overlap_sf,
                              possibly(~ st_area(.x))
                            ),
         percent_overlap = map2(.x = overlap_area,
                                .y = concave_sf,
                               possibly(~ (.x / st_area(.y))*100)
                              )
  ) %>% 
  unnest(cols = c(overlap_area, percent_overlap))
```

Take a look at the contents of `bees_overlap`. You can see the overlap area and percentage overlap for each species.

```{r}
bees_overlap 
```

### Rank species by their area overlap with fire and take the top 3

We will now rank all bee species by their percentage range overlap with fire extent (`percent_overlap`), and take the top 3 species with the highest overlap.

```{r}
top3 <- bees_overlap %>% 
  slice_max(order_by = percent_overlap,
              n = 3) 

top3
```

## Visualise fire extent and range overlap

### Prepare data for plotting

Now that we have selected the top three species , we will select the variables we need for plotting then unnest the list column structure. Once we have the data we want, we will rename the columns to variable names that are more intuitive for plotting. 

```{r, warnings = FALSE}
bee_map_data <- top3 %>% 
  select(scientific_name, points_sf, concave_sf, overlap_sf) %>% 
  unnest() %>% 
  rename(points = geometry, 
         concave = polygons, 
         overlap = geometry1) 
```

### Create a base map

We will first make the base map of Australia and the fire extent

```{r}
base_map <- ggplot() + 
  geom_sf(data = aus, colour = "black", fill = NA) +
  geom_sf(data = fire, fill = "#FEC3A6", colour = "#FEC3A6") + 
  theme_minimal()

base_map
```

### Add overlap of selected species

We will then add on the top 3 species' concave hull and their range overlap. Note that we are using `geometry = ` within `aes()` to specify which variable from `bee_map_data` we want to plot. 

```{r}
main_map <- base_map + 
  geom_sf(data = bee_map_data, 
          aes(geometry = concave, 
              colour = scientific_name, 
              fill = scientific_name), 
          size = 1.5, alpha = 0.1) + 
  geom_sf(data = bee_map_data, 
          aes(geometry = overlap), 
          colour = "#FF925C", fill = "#FF925C") + 
  geom_sf(data = bee_map_data, 
          aes(geometry = points, 
              colour = scientific_name), 
          size = 1) + 
  scale_colour_manual(values = c("#023E50", "#7B8A6A", "#3C908E")) + 
  scale_fill_manual(values = c("#023E50", "#7B8A6A", "#3C908E")) + 
  guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
  coord_sf(xlim = c(128, 158)) +
  theme(legend.title= element_blank(),
        legend.position = "bottom") 

main_map
```

### Add inset map

We will make an enlarged inset paper so we can see the navy blue hull of *Austroplebeia cassiae* is better

```{r}
inset <- main_map + 
   coord_sf(
    xlim = c(142.8 , 145.3),
    ylim = c(-15.9, -13.25),
    expand = FALSE
            ) + 
   theme_void() +
   theme(legend.position = "none",
         panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.2 ))

inset
```

#### Draw a box around the inset area 

Next we will draw a box around the area of interest on in the enlarged map.

```{r}
main_bbox <- main_map + 
   geom_rect(aes(xmin = 142.8, xmax = 145.3,
             ymin = -15.9, ymax = -13.25),
             colour = "black",
             fill = NA, 
             lwd = 0.2) 

main_bbox
```

### Put it all together

Finally, we can put it all together! 

```{r}
ggdraw(main_bbox) +
  draw_plot(inset, 
            x = 0.52, y = 0.63, 
            width =0.45, height = 0.3)
```

## Vascular plant dataset

Now we will repeat the above workflow using the vascular plant dataset.  [Describe data smaller spatial scope, descriptive stats about data set number of observations/fam/class etc] [Talk about the peas] Instead of taking top 3 species...we will be look at the bitterpeas

### Visualise the range overlap of *Daviesia* peas with fire extent

```{r, collapse=TRUE}
# Extract candidate genus
daviesia <- vplant_nest %>% 
  filter(genus == "Daviesia")

# Compute concave hulls
daviesia_concave <- daviesia %>%
    mutate(points_sf = map(.x = coords,
                           ~ st_as_sf(.x, coords = c("longitude", "latitude"),
                                      crs = 4326)
                           ), 
           concave_sf = map(points_sf,
                            ~ concaveman(.x)
           )
           )

# Compute range overlap and descriptive statistics
daviesia_overlap <- daviesia_concave %>% 
  mutate(overlap_sf = map(concave_sf, 
                       possibly(~ st_intersection(fire, .x) %>% select(-Id))
                       ),
         overlap_area = map(overlap_sf,
                              possibly(~ st_area(.x))
                            ),
         percent_overlap = map2(.x = overlap_area,
                                .y = concave_sf,
                               possibly(~ (.x / st_area(.y))*100)
                              )
  ) %>% 
  unnest(cols = c(overlap_area, percent_overlap))

## Prepare for plotting and rename variables
daviesia_map_data <- daviesia_overlap %>% 
  select(species, overlap_area, percent_overlap, points_sf, concave_sf, overlap_sf) %>% 
  unnest() %>% 
  rename(points = geometry, 
         concave = polygons, 
         overlap = geometry1) 

## Plant's main map reusing base_map from above
daviesia_main_map <- base_map + 
    geom_sf(data = daviesia_map_data, 
          aes(geometry = concave, 
              colour = species, 
              fill = species), 
          size = 1.5, alpha = 0.005) + 
  geom_sf(data = daviesia_map_data, 
          aes(geometry = overlap), 
          colour = "#FF925C", fill = "#FF925C") + 
  geom_sf(data = daviesia_map_data, 
          aes(geometry = points, 
              colour = species), 
          size = 0.9
          ) + 
  scale_colour_manual(values = c("#023E50", "#7B8A6A", "#3C908E" )) + 
  scale_fill_manual(values = c("#023E50", "#7B8A6A", "#3C908E")) + 
  guides(colour = guide_legend(override.aes = list(alpha = 1))) + 
  coord_sf(xlim = c(140, 158),
           ylim = c(-23, -43)) +
  theme_void() +
  theme(legend.title= element_blank(),
        legend.position = "bottom") 

daviesia_main_map

# Inset 1
daviesia_inset_1 <- daviesia_main_map + 
  coord_sf(
    xlim = c(145.5 , 150.3),
    ylim = c(-35, -37.95),
    expand = FALSE
  ) + 
  theme_void() +
  theme(legend.position = "none",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.2))

# Inset 2
daviesia_inset_2 <- daviesia_main_map +
  coord_sf(
    xlim = c(151.55 , 152.75),
    ylim = c(-28.6, -31.25),
    expand = FALSE
  ) + 
  theme_void() +
  theme(legend.position = "none",
        panel.border = element_rect(colour = "black", fill = NA, linewidth = 0.2))

daviesia_inset_2

# Drawing the inset boxes on main map
daviesia_bbox <- daviesia_main_map + 
   geom_rect(aes(xmin = 145.5, xmax = 150.3, # Inset 1
             ymin = -35, ymax = -37.95),
             colour = "black",
             fill = NA, linewidth = 0.2) + 
  geom_rect(aes(xmin = 151.55, xmax = 152.75, # Inset 2
             ymin = -28.6, ymax = -31.25),
             colour = "black",
             fill = NA, linewidth = 0.2) 

# Daviesia plot with insets 
ggdraw(daviesia_bbox) +
  draw_plot(daviesia_inset_1, x = 0.51, y = 0.16, 
            width = 0.45, height = 0.30) +
  draw_plot(daviesia_inset_2, x = 0.48, y = 0.51, 
            width = 0.5, height = 0.4)
```

