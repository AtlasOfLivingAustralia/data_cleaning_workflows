---
title: "Data check and clean of Vascular Plant data"
author: "Fonti Kar"
date: "2023-01-09"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = TRUE,
                      include = TRUE,
                      fig.align='center')

# Load R packages
pacman::p_load(remotes, galah, tidyverse, here, skimr, janitor, stringr)

# Configure galah
galah_config(email = "fonti.kar@gmail.com", 
             atlas = "Australia",
             download_reason_id = 10 # testing reason
             )
```

## Read in data

```{r}
vasc <- read_csv(here("data", "plants", "vascularplant.data.csv"))

skim(vasc)
```

## Summaries of all taxonomic levels

We've identified: 
- 8 taxa that have NA for `class`
- 25 taxa that have NA for `order`
- 89 taxa that have NA for `genus`

```{r}
vasc %>% 
  group_by(phylum) %>%
  summarise(n_sp = length(unique(scientific_name)))
  
vasc %>% 
  group_by(class) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>% 
  print(n = 50)

vasc %>% 
  group_by(order) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>%
  arrange(n_sp) %>% 
  print(n = 50)

vasc %>% 
  group_by(family) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>%
  filter(is.na(family))

vasc %>% 
  group_by(genus) %>% 
  summarise(n_sp = length(unique(scientific_name))) %>%
  filter(is.na(genus))


# By species
vasc %>% 
  group_by(phylum) %>%
  summarise(n_sp = length(unique(species)))
  
vasc %>% 
  group_by(class) %>% 
  summarise(n_sp = length(unique(species))) %>% 
  print(n = 50)

vasc %>% 
  group_by(order) %>% 
  summarise(n_sp = length(unique(species))) %>%
  arrange(n_sp) %>% 
  print(n = 50)

vasc %>% 
  group_by(family) %>% 
  summarise(n_sp = length(unique(species))) %>%
  filter(is.na(family))

vasc %>% 
  group_by(genus) %>% 
  summarise(n_sp = length(unique(species))) %>%
  filter(is.na(genus))
```

### Investigating missing taxonomic information

```{r}
# These are the taxa missing `class` information
vasc %>% 
  filter(is.na(class)) %>% 
  pull(scientific_name) %>% 
  unique()

# These are the taxa missing `order` information
vasc %>% 
  filter(is.na(order)) %>% 
  pull(scientific_name) %>% 
  unique()

# These are the taxa missing `genus` information
vasc %>% 
  filter(is.na(genus)) %>% 
  pull(scientific_name) %>% 
  unique()
```

### Recover missing taxonomic information using ALA 

None of the taxa with missing taxonomic information can be found in ALA

```{r}
#`class` 
vasc %>% 
  filter(is.na(class)) %>% 
  select(scientific_name) %>% 
  distinct() %>% search_taxa()

# `order`
vasc %>% 
  filter(is.na(order)) %>% 
  select(scientific_name) %>% 
  distinct() %>% search_taxa()

# `genus`
vasc %>% 
  filter(is.na(genus)) %>% 
  select(scientific_name) %>% 
  distinct() %>% search_taxa()
```

## Inconsistent higher taxonomic information

#### For `class`
##### By `species`

- 27 taxa that have same value for `species`, has more than 1 value for `class` 

```{r}
# Check if there are taxa that have same value for `species` but more than 1 value for `class`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_class > 1)

# Identify taxa that have but more than 1 value for `class`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_class > 1)  %>% 
  pull(species) -> inconsistent_class

# Filter taxa that has inconsistent class information
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(species %in% inconsistent_class) %>% 
  distinct() %>% 
  arrange(species) %>% 
  select(phylum:species, scientific_name) %>% 
  print(n = 100)
```
##### By `scientific_name`

- 29 taxa that have same value for `scientific_name`, has more than 1 value for `class` 
```{r}
# Check if there are taxa that have same value for `species` but more than 1 value for `class`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(scientific_name) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_class > 1)

# Identify taxa that have but more than 1 value for `class`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(scientific_name) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_class > 1)  %>% 
  pull(scientific_name) -> inconsistent_class_sn

# Filter taxa that has inconsistent class information
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(scientific_name %in% inconsistent_class_sn) %>% 
  distinct() %>% 
  arrange(scientific_name) %>% 
  print(n = 100)
```

#### For `order`

##### By `species`

- 1 taxa has same value for `species` but more than 1 value for `order`

```{r}
# Check if there are taxa have same `species` but more than 1 value for `order`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_order > 1) 

# Identify taxa that have but more than 1 value for `order`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_order > 1) %>% 
  pull(species) -> inconsistent_order

# Filter taxa that have inconsistent `order`
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(species %in% inconsistent_order) %>% 
  distinct() %>% 
  arrange(species) %>% 
  print(n = 100)
```

##### By `scientific_name`

No taxa has same value for `scientific_name` and multiple values for `order`

```{r}
# Check if there are taxa have same `scientific_name` but more than 1 value for `order`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(scientific_name) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_order > 1) 

```

#### For `family`

##### By `species` 

No taxa has same value for `species ` and multiple values for `family` 

```{r}
# Check if there are `taxa that have same `species` but more than 1 value for `family`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_fam > 1) 
```

##### By `scientific_name`

No taxa has same value for `scientific_name ` and multiple values for `family` 

```{r}
# Check if there are taxa that have same `scientific_name` but more than 1 value for `family`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(scientific_name) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_fam > 1) 

```

#### For `genus`

##### By `species`

- 9 taxa has same value for `species ` and multiple values for `genus` 

```{r}
# Check if there are `taxa that have same `species` but more than 1 value for `family`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_genus > 1) 

# Identify taxa that have but more than 1 value for `genus`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_genus > 1) %>% 
  pull(species) -> inconsistent_genus

# Filter taxa that have inconsistent `genus`
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(species %in% inconsistent_genus) %>% 
  distinct() %>% 
  arrange(species) %>% 
  print(n = 100)
```

##### By `scientific_name`

- 9 taxa has same value for `scientific_name ` and multiple values for `genus` 

```{r}
# Check if there are `taxa that have same `scientific_name` but more than 1 value for `family`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(scientific_name) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_genus > 1) 

# Identify taxa that have but more than 1 value for `genus`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(scientific_name) %>% 
  summarise(n_class = length(unique(class)),
            n_order = length(unique(order)),
            n_fam = length(unique(family)),
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_genus > 1) %>% 
  pull(scientific_name) -> inconsistent_genus

# Filter taxa that have inconsistent `genus`
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(scientific_name %in% inconsistent_genus) %>% 
  distinct() %>% 
  arrange(scientific_name) %>% 
  print(n = 100)
```




