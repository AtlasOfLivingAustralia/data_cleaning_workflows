---
title: "Vasc Plant Data Fix"
author: "Fonti Kar"
date: "2023-01-30"
output:
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      eval = TRUE,
                      include = TRUE,
                      fig.align='center')

# Load R packages
pacman::p_load(remotes, galah, tidyverse, here, skimr, janitor, stringr)

# Configure galah
galah_config(email = "fonti.kar@gmail.com", 
             atlas = "Australia",
             download_reason_id = 10 # testing reason
             )
```

### Read in data

```{r}
vasc <- read_csv(here("data", "plants", "vascularplant.data.csv"))

skim(vasc)
```


### Investigating missing taxonomic information

#### Missing `class` information

These are the taxa missing `class` information
```{r}
vasc %>% 
  filter(is.na(class)) %>% 
  select(scientific_name:subspecies, scientific_name_original) %>% 
  distinct()
```
##### Proposed amendment: recover `class` information with ALA taxonomy

We were unable to recover class information using ALA taxonomy, leave as NA?

```{r}
vasc %>% 
  filter(is.na(class)) %>% 
  select(species) %>% 
  distinct() %>% 
  search_taxa()
```

#### Missing `order` information

These are the taxa missing `order` information
```{r}
vasc %>% 
  filter(is.na(order)) %>% 
  select(scientific_name:subspecies, scientific_name_original) %>% 
  distinct()
```

##### Proposed amendment: Recover `order` information with ALA taxonomy

We were unable to recover `order` information using ALA taxonomy, leave as NA?

```{r}
vasc %>% 
  filter(is.na(order)) %>% 
  select(species) %>% 
  distinct() %>% 
  search_taxa()
```


#### Missing `genus` information

These are the taxa missing `genus` information

```{r}
vasc %>% 
  filter(is.na(genus)) %>% 
  select(scientific_name:subspecies, scientific_name_original) %>% 
  distinct()
```

##### Proposed amendment: Take first word of either `species` or `scientific_name`

```{r}
vasc %>% 
  mutate(genus_fixed = ifelse(is.na(genus), word(species), genus)) %>% 
  filter(is.na(genus)) %>%
  select(scientific_name, genus, genus_fixed, species) %>% 
  distinct() %>% 
  print(n = 100)
```

### Inconsistent higher taxonomic information

From my checks, family level data is ok and no inconsistencies were flagged

#### By `species`

##### Taxa with inconsistent `class` 

- 27 taxa that have same value for `species`, has more than 1 value for `class` 

```{r}
# Check if there are taxa that have same value for `species` but more than 1 value for `class`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>%  # Selects all taxonomic variables
  distinct() %>%  # Filters down to distinct rows of taxonomic variables
  arrange(class, order, family, genus, species) %>%  # Sort data by class, order...etc
  group_by(species) %>% # For every unique species
  summarise(n_class = length(unique(class)) # Sum the number of unique values it has for class
            ) %>% 
  filter(n_class > 1) %>%  # Filters species that have more than 1 unique class
  print(n = 30)

vasc %>% 
  select(phylum:subspecies, scientific_name) %>%  # Selects all taxonomic variables
  distinct() %>%  # Filters down to distinct rows of taxonomic variables
  arrange(class, order, family, genus, species) %>%  # Sort data by class, order...etc
  group_by(species) %>% # For every unique species
  summarise(n_class = length(unique(class)) # Sum the number of unique values it has for class
            ) %>% 
  filter(n_class > 1)  %>% 
  pull(species) -> inconsistent_class

# Filter taxa that has inconsistent class information
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(species %in% inconsistent_class) %>% 
  distinct() %>% 
  arrange(species) %>%
  print(n = 100)
```

###### Proposed amendment: Take class from ALA taxonomy

Unable to find matches in ALA taxonomy, need other solution
```{r}
inconsistent_class %>% search_taxa()
```

##### Taxa with inconsistent `order`

- 1 taxa has same value for `species` but more than 1 value for `order`

```{r}
# Check if there are taxa have same `species` but more than 1 value for `order`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_order = length(unique(order))) %>% 
  filter(n_order > 1) 

# Identify taxa that have but more than 1 value for `order`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(n_order = length(unique(order))) %>% 
  filter(n_order > 1)  %>% 
  pull(species) -> inconsistent_order

# Filter taxa that have inconsistent `order`
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(species %in% inconsistent_order) %>% 
  distinct() %>% 
  arrange(species) 
```

###### Proposed amendment: Set `order` based on data on other row for the same species

If `species` is the same e.g. Thelychiton speciosus and one row has NA and other has `Asparagales` for the `order.` Set `Asparagales` as the `order` for the row that is missing `order`

```{r}
vasc %>% 
  mutate(order_fixed = ifelse(species %in% inconsistent_order, "Asparagales", order)) %>% 
  filter(species %in% inconsistent_order) %>% 
  select(phylum:order, order_fixed, family:subspecies, scientific_name) %>% 
  distinct()
```

##### Taxa with inconsistent `genus`

Not that some inconsistencies is due to NA for `genus`, but even then, `genus` doesn't match first word of `species` or `scientific_name`

```{r}
# Check if there are `taxa that have same `species` but more than 1 value for `genus`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_genus > 1)

# Identify taxa that have but more than 1 value for `genus`
vasc %>% 
  select(phylum:subspecies, scientific_name) %>% 
  distinct() %>% 
  arrange(class, order, family, genus, species) %>% 
  group_by(species) %>% 
  summarise(
            n_genus = length(unique(genus))
            ) %>% 
  filter(n_genus > 1) %>% 
  pull(species) -> inconsistent_genus

# Filter taxa that have inconsistent `genus`
vasc %>% 
 select(phylum:subspecies, scientific_name) %>% 
  filter(species %in% inconsistent_genus) %>% 
  distinct() %>% 
  arrange(species) %>% 
  print(n = 100)
```

###### Proposed amendment: Take first word of either `species` or `scientific_name`

```{r}
vasc %>% 
  mutate(first_word = word(species),
         genus_fixed = ifelse(is.na(genus), word(species), genus)
         ) %>% 
  filter(! genus == first_word) %>%  # Filters taxa when genus doesn't match the first word of species
  select(species, first_word, genus, genus_fixed, scientific_name) %>% 
  distinct()
```
